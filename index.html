<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMK-DataBase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK (Version e thjeshtë për GitHub Pages) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --crm-color: #27ae60;
            --light-grey: #f5f5f5;
            --medium-grey: #e0e0e0;
            --dark-grey: #7f8c8d;
            --white: #ffffff;
            --text-color: #333333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background-color: var(--light-grey);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header and Navigation */
        header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 1rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
            display: flex;
            align-items: center;
        }
        
        .logo i {
            margin-right: 8px;
            color: var(--accent-color);
        }
        
        .nav-menu {
            display: flex;
            list-style: none;
        }
        
        .nav-item {
            margin-left: 1rem;
        }
        
        .nav-link {
            color: var(--white);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 0.8rem;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: var(--accent-color);
        }
        
        .nav-link.crm-link:hover, .nav-link.crm-link.active {
            background-color: var(--crm-color);
        }
        
        /* Login form */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70vh;
            padding: 2rem;
        }
        
        .login-box {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
        }
        
        .login-title {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        /* Mobile menu toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* Main Content Area */
        main {
            min-height: calc(100vh - 140px);
            padding: 1.5rem 0;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--medium-grey);
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .page-title {
            font-size: 1.6rem;
            color: var(--primary-color);
        }
        
        .btn {
            background-color: var(--accent-color);
            color: var(--white);
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .btn.crm-btn {
            background-color: var(--crm-color);
        }
        
        .btn.crm-btn:hover {
            background-color: #219653;
        }
        
        .btn i {
            margin-right: 6px;
        }
        
        .btn.logout-btn {
            background-color: #e74c3c;
            margin-left: 10px;
        }
        
        .btn.logout-btn:hover {
            background-color: #c0392b;
        }
        
        /* Content Cards */
        .content-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.2rem;
            margin-top: 1rem;
        }
        
        .card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.2rem;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid var(--medium-grey);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .card-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            line-height: 1.3;
        }
        
        .card-date {
            color: var(--dark-grey);
            font-size: 0.85rem;
            margin-top: 0.3rem;
        }
        
        .card-details {
            color: var(--text-color);
            margin-bottom: 1rem;
            flex-grow: 1;
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid var(--medium-grey);
        }
        
        .card-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--dark-grey);
            transition: color 0.3s ease;
            font-size: 0.85rem;
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
        }
        
        .action-btn:hover {
            color: var(--accent-color);
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        /* CRM Table Styles */
        .crm-container {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.2rem;
            margin-top: 1rem;
            overflow-x: auto;
        }
        
        .crm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--medium-grey);
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .crm-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        
        .crm-title i {
            margin-right: 8px;
            color: var(--crm-color);
        }
        
        .crm-subtitle {
            color: var(--dark-grey);
            font-size: 0.95rem;
            margin-top: 0.2rem;
        }
        
        .crm-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            min-width: 600px;
        }
        
        .crm-table th {
            background-color: var(--light-grey);
            padding: 0.8rem;
            text-align: left;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 2px solid var(--medium-grey);
            font-size: 0.9rem;
        }
        
        .crm-table td {
            padding: 0.8rem;
            border-bottom: 1px solid var(--medium-grey);
            vertical-align: middle;
            font-size: 0.9rem;
        }
        
        .crm-table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .crm-table input, .crm-table select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--medium-grey);
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .crm-table input:focus, .crm-table select:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .deal-status {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-new {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .status-negotiation {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .status-won {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-lost {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .status-postponed {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        
        /* Modal for adding items */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: var(--white);
            width: 100%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.3s ease;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        @keyframes modalFadeIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 1.2rem;
            border-bottom: 1px solid var(--medium-grey);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-grey);
        }
        
        .modal-body {
            padding: 1.2rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.95rem;
        }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid var(--medium-grey);
            border-radius: 4px;
            font-size: 0.95rem;
            transition: border 0.3s ease;
        }
        
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-footer {
            padding: 1.2rem;
            border-top: 1px solid var(--medium-grey);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        
        /* Footer */
        footer {
            background-color: var(--secondary-color);
            color: var(--white);
            text-align: center;
            padding: 1.2rem 0;
            margin-top: 2rem;
            font-size: 0.9rem;
        }
        
        /* Status indicators */
        .status {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status.confirmed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status.completed {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        /* Sponsor level indicators */
        .sponsor-level {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .level-platinum {
            background-color: #e5e4e2;
            color: #333;
        }
        
        .level-gold {
            background-color: #ffd700;
            color: #333;
        }
        
        .level-silver {
            background-color: #c0c0c0;
            color: #333;
        }
        
        /* Progress bar */
        .progress-bar {
            background: #eee;
            border-radius: 4px;
            margin: 8px 0;
            height: 16px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: #3498db;
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        /* Priority indicators */
        .priority-high {
            color: #e74c3c;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .priority-medium {
            color: #f39c12;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .priority-low {
            color: #27ae60;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        /* Summary cards */
        .summary-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .summary-card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.2rem;
            text-align: center;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.4rem;
        }
        
        .summary-label {
            color: var(--dark-grey);
            font-size: 0.85rem;
        }
        
        /* Event selector for CRM */
        .event-selector {
            display: flex;
            align-items: center;
            margin-bottom: 1.2rem;
            padding: 0.8rem;
            background-color: var(--light-grey);
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 0.8rem;
        }
        
        .event-selector label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.95rem;
        }
        
        .event-selector select {
            padding: 0.5rem 0.8rem;
            border: 1px solid var(--medium-grey);
            border-radius: 4px;
            font-size: 0.95rem;
            flex-grow: 1;
            min-width: 200px;
        }
        
        /* Action buttons in table */
        .table-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--dark-grey);
            margin: 0 2px;
            transition: color 0.3s ease;
            font-size: 1rem;
        }
        
        .table-action-btn:hover {
            color: var(--accent-color);
        }
        
        .table-action-btn.delete:hover {
            color: #e74c3c;
        }
        
        .table-action-btn.save:hover {
            color: var(--crm-color);
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--dark-grey);
        }
        
        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--medium-grey);
        }
        
        /* Loading indicator */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--dark-grey);
        }
        
        .loading-spinner {
            border: 3px solid var(--light-grey);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design - Mobile */
        @media (max-width: 992px) {
            .content-container {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .header-container {
                flex-wrap: wrap;
            }
            
            .logo {
                font-size: 1.3rem;
            }
            
            .mobile-menu-toggle {
                display: block;
                order: 1;
            }
            
            .nav-menu {
                display: none;
                width: 100%;
                flex-direction: column;
                margin-top: 1rem;
                order: 3;
            }
            
            .nav-menu.active {
                display: flex;
            }
            
            .nav-item {
                margin-left: 0;
                margin-bottom: 0.5rem;
                width: 100%;
            }
            
            .nav-link {
                display: block;
                width: 100%;
                text-align: left;
                padding: 0.8rem 1rem;
            }
            
            .page-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .page-title {
                font-size: 1.4rem;
            }
            
            .content-container {
                grid-template-columns: 1fr;
            }
            
            .crm-header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.8rem;
            }
            
            .summary-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .event-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .event-selector label {
                width: 100%;
            }
            
            .event-selector select {
                width: 100%;
            }
            
            .login-box {
                padding: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            
            .card {
                padding: 1rem;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .card-footer {
                flex-direction: column;
                align-items: stretch;
                gap: 0.8rem;
            }
            
            .card-actions {
                justify-content: center;
            }
            
            .crm-table {
                font-size: 0.8rem;
            }
            
            .crm-table th, .crm-table td {
                padding: 0.6rem;
            }
            
            .summary-container {
                grid-template-columns: 1fr;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .modal-content {
                max-height: 90vh;
            }
        }
        
        /* Small phone optimization */
        @media (max-width: 360px) {
            .card-title {
                font-size: 1.1rem;
            }
            
            .action-btn {
                padding: 0.2rem 0.3rem;
                font-size: 0.8rem;
            }
            
            .crm-table {
                min-width: 500px;
            }
        }
        
        /* Tablet optimization */
        @media (min-width: 769px) and (max-width: 1024px) {
            .content-container {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
            
            .container {
                max-width: 95%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen (Initially shown) -->
    <div id="login-screen">
        <header>
            <div class="container header-container">
                <div class="logo">
                    <i class="fas fa-database"></i>
                    <span>EMK-DataBase</span>
                </div>
            </div>
        </header>
        
        <div class="login-container">
            <div class="login-box">
                <h1 class="login-title">Welcome to EMK Database</h1>
                <div class="form-group">
                    <label for="login-email" class="form-label">Email</label>
                    <input type="email" id="login-email" class="form-input" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="login-password" class="form-label">Password</label>
                    <input type="password" id="login-password" class="form-input" placeholder="Enter your password">
                </div>
                <div class="form-group">
                    <button class="btn" id="login-btn" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
                <div class="form-group" style="text-align: center; margin-top: 1rem;">
                    <p style="color: var(--dark-grey); font-size: 0.9rem;">
                        Don't have an account? <a href="#" id="show-register" style="color: var(--accent-color);">Register</a>
                    </p>
                </div>
            </div>
            
            <!-- Register Form (Hidden by default) -->
            <div class="login-box" id="register-box" style="display: none; margin-top: 2rem;">
                <h1 class="login-title">Create Account</h1>
                <div class="form-group">
                    <label for="register-email" class="form-label">Email</label>
                    <input type="email" id="register-email" class="form-input" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="register-password" class="form-label">Password</label>
                    <input type="password" id="register-password" class="form-input" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="register-name" class="form-label">Full Name</label>
                    <input type="text" id="register-name" class="form-input" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <button class="btn crm-btn" id="register-btn" style="width: 100%;">
                        <i class="fas fa-user-plus"></i> Register
                    </button>
                </div>
                <div class="form-group" style="text-align: center; margin-top: 1rem;">
                    <p style="color: var(--dark-grey); font-size: 0.9rem;">
                        Already have an account? <a href="#" id="show-login" style="color: var(--accent-color);">Login</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="app-container" style="display: none;">
        <!-- Header with Navigation -->
        <header>
            <div class="container header-container">
                <div class="logo">
                    <i class="fas fa-database"></i>
                    <span>EMK-DataBase</span>
                </div>
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <ul class="nav-menu" id="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-page="events">Event Section</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="sponsors">Sponsor Details</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="goals">EMK Goals</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link crm-link" data-page="crm">CRM & Deals</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn logout-btn" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </li>
                </ul>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container">
            <!-- Events Page -->
            <section id="events-page" class="page active">
                <div class="page-header">
                    <h1 class="page-title">Event Section</h1>
                    <button class="btn" id="add-event-btn">
                        <i class="fas fa-plus"></i> Add New Event
                    </button>
                </div>
                <div class="content-container" id="events-container">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading events...</p>
                    </div>
                </div>
            </section>

            <!-- Sponsors Page -->
            <section id="sponsors-page" class="page">
                <div class="page-header">
                    <h1 class="page-title">Sponsor Details</h1>
                    <button class="btn" id="add-sponsor-btn">
                        <i class="fas fa-plus"></i> Add New Sponsor
                    </button>
                </div>
                <div class="content-container" id="sponsors-container">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading sponsors...</p>
                    </div>
                </div>
            </section>

            <!-- Goals Page -->
            <section id="goals-page" class="page">
                <div class="page-header">
                    <h1 class="page-title">EMK Goals</h1>
                    <button class="btn" id="add-goal-btn">
                        <i class="fas fa-plus"></i> Add New Goal
                    </button>
                </div>
                <div class="content-container" id="goals-container">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading goals...</p>
                    </div>
                </div>
            </section>

            <!-- CRM Page -->
            <section id="crm-page" class="page">
                <div class="page-header">
                    <h1 class="page-title">CRM & Deal Management</h1>
                    <button class="btn crm-btn" id="add-deal-btn">
                        <i class="fas fa-plus"></i> Add New Deal
                    </button>
                </div>
                
                <div class="event-selector">
                    <label for="crm-event-select">Select Event:</label>
                    <select id="crm-event-select">
                        <option value="">-- Select an Event --</option>
                    </select>
                </div>
                
                <div class="summary-container">
                    <div class="summary-card">
                        <div class="summary-value" id="total-deals">0</div>
                        <div class="summary-label">Total Deals</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="won-deals">0</div>
                        <div class="summary-label">Deals Won</div>
                    </div>
                </div>
                
                <div class="crm-container">
                    <div class="crm-header">
                        <div>
                            <div class="crm-title">
                                <i class="fas fa-table"></i>
                                Deal Tracker
                            </div>
                            <div class="crm-subtitle" id="crm-event-title">Select an event to view and manage deals</div>
                        </div>
                        <button class="btn crm-btn" id="export-csv-btn">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                    
                    <div id="crm-table-container">
                        <div class="empty-state">
                            <i class="fas fa-table"></i>
                            <h3>No Event Selected</h3>
                            <p>Select an event from the dropdown above to view and manage deals</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Modals for adding content -->
        <!-- Add Event Modal -->
        <div id="event-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Add New Event</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <form id="event-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="event-title" class="form-label">Event Title *</label>
                            <input type="text" id="event-title" class="form-input" required placeholder="Enter event title">
                        </div>
                        <div class="form-group">
                            <label for="event-date" class="form-label">Event Date *</label>
                            <input type="date" id="event-date" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="event-location" class="form-label">Location *</label>
                            <input type="text" id="event-location" class="form-input" required placeholder="Enter event location">
                        </div>
                        <div class="form-group">
                            <label for="event-description" class="form-label">Description *</label>
                            <textarea id="event-description" class="form-textarea" required placeholder="Enter event description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="event-status" class="form-label">Status</label>
                            <select id="event-status" class="form-select">
                                <option value="pending">Pending</option>
                                <option value="confirmed" selected>Confirmed</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn close-modal">Cancel</button>
                        <button type="submit" class="btn">Add Event</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Sponsor Modal -->
        <div id="sponsor-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Add New Sponsor</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <form id="sponsor-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="sponsor-name" class="form-label">Sponsor Name *</label>
                            <input type="text" id="sponsor-name" class="form-input" required placeholder="Enter sponsor name">
                        </div>
                        <div class="form-group">
                            <label for="sponsor-email" class="form-label">Contact Email *</label>
                            <input type="email" id="sponsor-email" class="form-input" required placeholder="Enter contact email">
                        </div>
                        <div class="form-group">
                            <label for="sponsor-phone" class="form-label">Contact Phone</label>
                            <input type="tel" id="sponsor-phone" class="form-input" placeholder="Enter contact phone number">
                        </div>
                        <div class="form-group">
                            <label for="sponsor-level" class="form-label">Sponsorship Level</label>
                            <select id="sponsor-level" class="form-select">
                                <option value="platinum">Platinum</option>
                                <option value="gold" selected>Gold</option>
                                <option value="silver">Silver</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sponsor-notes" class="form-label">Notes</label>
                            <textarea id="sponsor-notes" class="form-textarea" placeholder="Enter any additional notes about this sponsor"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn close-modal">Cancel</button>
                        <button type="submit" class="btn">Add Sponsor</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Goal Modal -->
        <div id="goal-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Add New EMK Goal</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <form id="goal-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="goal-title" class="form-label">Goal Title *</label>
                            <input type="text" id="goal-title" class="form-input" required placeholder="Enter goal title">
                        </div>
                        <div class="form-group">
                            <label for="goal-deadline" class="form-label">Deadline *</label>
                            <input type="date" id="goal-deadline" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="goal-priority" class="form-label">Priority</label>
                            <select id="goal-priority" class="form-select">
                                <option value="high">High</option>
                                <option value="medium" selected>Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="goal-description" class="form-label">Description *</label>
                            <textarea id="goal-description" class="form-textarea" required placeholder="Enter goal description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="goal-progress" class="form-label">Progress (%)</label>
                            <input type="range" id="goal-progress" class="form-input" min="0" max="100" value="0">
                            <span id="progress-value">0%</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn close-modal">Cancel</button>
                        <button type="submit" class="btn">Add Goal</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Deal Modal -->
        <div id="deal-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Add New Deal</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <form id="deal-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="deal-event" class="form-label">Event *</label>
                            <select id="deal-event" class="form-select" required>
                                <option value="">-- Select Event --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deal-company" class="form-label">Company *</label>
                            <input type="text" id="deal-company" class="form-input" required placeholder="Enter company name">
                        </div>
                        <div class="form-group">
                            <label for="deal-contact" class="form-label">Contact Person</label>
                            <input type="text" id="deal-contact" class="form-input" placeholder="Enter contact person name">
                        </div>
                        <div class="form-group">
                            <label for="deal-email" class="form-label">Contact Email</label>
                            <input type="email" id="deal-email" class="form-input" placeholder="Enter contact email">
                        </div>
                        <div class="form-group">
                            <label for="deal-phone" class="form-label">Contact Phone</label>
                            <input type="tel" id="deal-phone" class="form-input" placeholder="Enter contact phone">
                        </div>
                        <div class="form-group">
                            <label for="deal-status" class="form-label">Status</label>
                            <select id="deal-status" class="form-select">
                                <option value="new">New</option>
                                <option value="negotiation" selected>Negotiation</option>
                                <option value="won">Won</option>
                                <option value="lost">Lost</option>
                                <option value="postponed">Postponed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deal-notes" class="form-label">Notes</label>
                            <textarea id="deal-notes" class="form-textarea" placeholder="Enter any additional notes about this deal"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn close-modal">Cancel</button>
                        <button type="submit" class="btn crm-btn">Add Deal</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <div class="container">
                <p>EMK-DataBase &copy; 2023 | Cloud Database System</p>
                <p>All data is stored permanently in the cloud</p>
                <p id="user-email"></p>
            </div>
        </footer>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        // KONFIGURIMI YT I FIREBASE - E KE TË SHTËNË
        const firebaseConfig = {
            apiKey: "AIzaSyCclKkJ3yIhAqSu6P_Dh9mz4FZBxl0832Y",
            authDomain: "emk-database.firebaseapp.com",
            projectId: "emk-database",
            storageBucket: "emk-database.firebasestorage.app",
            messagingSenderId: "777924221119",
            appId: "1:777924221119:web:a71b7e36d09502c6a30e0a",
            measurementId: "G-90ZMVL87QC"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global variables
        let currentUser = null;
        let events = [];
        let sponsors = [];
        let goals = [];
        let deals = [];
        
        // DOM elements
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const registerBox = document.getElementById('register-box');
        const showRegister = document.getElementById('show-register');
        const showLogin = document.getElementById('show-login');
        const registerEmail = document.getElementById('register-email');
        const registerPassword = document.getElementById('register-password');
        const registerName = document.getElementById('register-name');
        const registerBtn = document.getElementById('register-btn');
        const userEmailElement = document.getElementById('user-email');
        
        // App DOM elements
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const addEventBtn = document.getElementById('add-event-btn');
        const addSponsorBtn = document.getElementById('add-sponsor-btn');
        const addGoalBtn = document.getElementById('add-goal-btn');
        const addDealBtn = document.getElementById('add-deal-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const eventModal = document.getElementById('event-modal');
        const sponsorModal = document.getElementById('sponsor-modal');
        const goalModal = document.getElementById('goal-modal');
        const dealModal = document.getElementById('deal-modal');
        const closeModalButtons = document.querySelectorAll('.close-modal');
        const eventForm = document.getElementById('event-form');
        const sponsorForm = document.getElementById('sponsor-form');
        const goalForm = document.getElementById('goal-form');
        const dealForm = document.getElementById('deal-form');
        const eventsContainer = document.getElementById('events-container');
        const sponsorsContainer = document.getElementById('sponsors-container');
        const goalsContainer = document.getElementById('goals-container');
        const crmEventSelect = document.getElementById('crm-event-select');
        const crmTableContainer = document.getElementById('crm-table-container');
        const crmEventTitle = document.getElementById('crm-event-title');
        const progressSlider = document.getElementById('goal-progress');
        const progressValue = document.getElementById('progress-value');
        const dealEventSelect = document.getElementById('deal-event');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const navMenu = document.getElementById('nav-menu');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Setup progress slider display
            if (progressSlider && progressValue) {
                progressSlider.addEventListener('input', function() {
                    progressValue.textContent = this.value + '%';
                });
            }
            
            // Setup mobile menu toggle
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                });
            }
            
            // Close mobile menu when clicking a link
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        navMenu.classList.remove('active');
                    }
                });
            });
            
            // Check if user is already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    showApp();
                    loadAllData();
                } else {
                    // No user is signed in
                    showLoginScreen();
                }
            });
            
            // Setup login/register toggles
            showRegister.addEventListener('click', function(e) {
                e.preventDefault();
                registerBox.style.display = 'block';
            });
            
            showLogin.addEventListener('click', function(e) {
                e.preventDefault();
                registerBox.style.display = 'none';
            });
        });

        // Show login screen
        function showLoginScreen() {
            loginScreen.style.display = 'block';
            appContainer.style.display = 'none';
        }

        // Show app
        function showApp() {
            loginScreen.style.display = 'none';
            appContainer.style.display = 'block';
            userEmailElement.textContent = `Logged in as: ${currentUser.email}`;
        }

        // Login function
        loginBtn.addEventListener('click', function() {
            const email = loginEmail.value;
            const password = loginPassword.value;
            
            if (!email || !password) {
                showNotification('Please enter email and password', 'warning');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in successfully
                    showNotification('Login successful!', 'success');
                    loginEmail.value = '';
                    loginPassword.value = '';
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    showNotification('Login failed: ' + error.message, 'error');
                });
        });

        // Register function
        registerBtn.addEventListener('click', function() {
            const email = registerEmail.value;
            const password = registerPassword.value;
            const name = registerName.value;
            
            if (!email || !password || !name) {
                showNotification('Please fill all fields', 'warning');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // User created successfully
                    const user = userCredential.user;
                    
                    // Update user profile with name
                    return user.updateProfile({
                        displayName: name
                    });
                })
                .then(() => {
                    showNotification('Registration successful!', 'success');
                    registerEmail.value = '';
                    registerPassword.value = '';
                    registerName.value = '';
                    registerBox.style.display = 'none';
                })
                .catch((error) => {
                    console.error('Registration error:', error);
                    showNotification('Registration failed: ' + error.message, 'error');
                });
        });

        // Logout function
        logoutBtn.addEventListener('click', function() {
            auth.signOut()
                .then(() => {
                    showNotification('Logged out successfully', 'info');
                })
                .catch((error) => {
                    console.error('Logout error:', error);
                    showNotification('Logout failed: ' + error.message, 'error');
                });
        });

        // ==================== FIRESTORE FUNCTIONS ====================

        // Load all data from Firestore
        function loadAllData() {
            loadEvents();
            loadSponsors();
            loadGoals();
            loadDeals();
        }

        // Load events from Firestore
        function loadEvents() {
            db.collection('events').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
                events = [];
                snapshot.forEach((doc) => {
                    events.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderEvents();
                updateEventSelectors();
            }, (error) => {
                console.error('Error loading events:', error);
                eventsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Events</h3>
                        <p>Could not load events from database</p>
                    </div>
                `;
            });
        }

        // Load sponsors from Firestore
        function loadSponsors() {
            db.collection('sponsors').orderBy('name').onSnapshot((snapshot) => {
                sponsors = [];
                snapshot.forEach((doc) => {
                    sponsors.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderSponsors();
            }, (error) => {
                console.error('Error loading sponsors:', error);
                sponsorsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Sponsors</h3>
                        <p>Could not load sponsors from database</p>
                    </div>
                `;
            });
        }

        // Load goals from Firestore
        function loadGoals() {
            db.collection('goals').orderBy('deadline').onSnapshot((snapshot) => {
                goals = [];
                snapshot.forEach((doc) => {
                    goals.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderGoals();
            }, (error) => {
                console.error('Error loading goals:', error);
                goalsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Goals</h3>
                        <p>Could not load goals from database</p>
                    </div>
                `;
            });
        }

        // Load deals from Firestore
        function loadDeals() {
            db.collection('deals').onSnapshot((snapshot) => {
                deals = [];
                snapshot.forEach((doc) => {
                    deals.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                updateCRMSummary();
                
                // Update CRM table if we're on that page
                const currentPage = document.querySelector('.page.active').id;
                if (currentPage === 'crm-page' && crmEventSelect.value) {
                    renderCRMTable(crmEventSelect.value);
                }
            }, (error) => {
                console.error('Error loading deals:', error);
            });
        }

        // Save event to Firestore
        function saveEvent(eventData) {
            return db.collection('events').add({
                ...eventData,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Save sponsor to Firestore
        function saveSponsor(sponsorData) {
            return db.collection('sponsors').add({
                ...sponsorData,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Save goal to Firestore
        function saveGoal(goalData) {
            return db.collection('goals').add({
                ...goalData,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Save deal to Firestore
        function saveDeal(dealData) {
            return db.collection('deals').add({
                ...dealData,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Update event in Firestore
        function updateEvent(eventId, eventData) {
            return db.collection('events').doc(eventId).update({
                ...eventData,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Update deal in Firestore
        function updateDeal(dealId, dealData) {
            return db.collection('deals').doc(dealId).update({
                ...dealData,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Update goal in Firestore
        function updateGoal(goalId, goalData) {
            return db.collection('goals').doc(goalId).update({
                ...goalData,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Delete event from Firestore
        function deleteEvent(eventId) {
            return db.collection('events').doc(eventId).delete();
        }

        // Delete sponsor from Firestore
        function deleteSponsor(sponsorId) {
            return db.collection('sponsors').doc(sponsorId).delete();
        }

        // Delete goal from Firestore
        function deleteGoal(goalId) {
            return db.collection('goals').doc(goalId).delete();
        }

        // Delete deal from Firestore
        function deleteDeal(dealId) {
            return db.collection('deals').doc(dealId).delete();
        }

        // Delete deals by event ID
        function deleteDealsByEvent(eventId) {
            const batch = db.batch();
            const eventDeals = deals.filter(deal => deal.eventId === eventId);
            
            eventDeals.forEach(deal => {
                const dealRef = db.collection('deals').doc(deal.id);
                batch.delete(dealRef);
            });
            
            return batch.commit();
        }

        // ==================== APP FUNCTIONALITY ====================

        // Navigation handling
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetPage = this.getAttribute('data-page');
                
                // Update active nav link
                navLinks.forEach(link => link.classList.remove('active'));
                this.classList.add('active');
                
                // Show target page
                pages.forEach(page => {
                    page.classList.remove('active');
                    if (page.id === `${targetPage}-page`) {
                        page.classList.add('active');
                    }
                });
                
                // If CRM page, update the table
                if (targetPage === 'crm') {
                    updateCRMSummary();
                    const selectedEventId = crmEventSelect.value;
                    if (selectedEventId) {
                        renderCRMTable(selectedEventId);
                    }
                }
            });
        });

        // Modal handling
        addEventBtn.addEventListener('click', () => openModal(eventModal));
        addSponsorBtn.addEventListener('click', () => openModal(sponsorModal));
        addGoalBtn.addEventListener('click', () => openModal(goalModal));
        addDealBtn.addEventListener('click', () => {
            // Populate event dropdown in deal modal
            populateDealEventSelect();
            openModal(dealModal);
        });
        exportCsvBtn.addEventListener('click', exportDealsToCSV);

        closeModalButtons.forEach(button => {
            button.addEventListener('click', () => {
                closeAllModals();
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeAllModals();
            }
        });

        function openModal(modal) {
            closeAllModals();
            modal.classList.add('active');
            
            // Set today's date as default for date inputs
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('event-date')) {
                document.getElementById('event-date').value = today;
            }
            if (document.getElementById('goal-deadline')) {
                document.getElementById('goal-deadline').value = today;
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        // Event selector change
        crmEventSelect.addEventListener('change', function() {
            const eventId = this.value;
            if (eventId) {
                renderCRMTable(eventId);
                
                // Update subtitle with event name
                const selectedEvent = events.find(e => e.id === eventId);
                if (selectedEvent) {
                    crmEventTitle.textContent = `Deals for: ${selectedEvent.title}`;
                }
            } else {
                crmTableContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-table"></i>
                        <h3>No Event Selected</h3>
                        <p>Select an event from the dropdown above to view and manage deals</p>
                    </div>
                `;
                crmEventTitle.textContent = 'Select an event to view and manage deals';
            }
        });

        // Form submissions
        eventForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newEvent = {
                title: document.getElementById('event-title').value,
                date: document.getElementById('event-date').value,
                location: document.getElementById('event-location').value,
                description: document.getElementById('event-description').value,
                status: document.getElementById('event-status').value
            };
            
            saveEvent(newEvent)
                .then(() => {
                    eventForm.reset();
                    closeAllModals();
                    showNotification('Event added successfully!', 'success');
                })
                .catch((error) => {
                    console.error('Error adding event:', error);
                    showNotification('Error adding event: ' + error.message, 'error');
                });
        });

        sponsorForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newSponsor = {
                name: document.getElementById('sponsor-name').value,
                email: document.getElementById('sponsor-email').value,
                phone: document.getElementById('sponsor-phone').value,
                level: document.getElementById('sponsor-level').value,
                notes: document.getElementById('sponsor-notes').value
            };
            
            saveSponsor(newSponsor)
                .then(() => {
                    sponsorForm.reset();
                    closeAllModals();
                    showNotification('Sponsor added successfully!', 'success');
                })
                .catch((error) => {
                    console.error('Error adding sponsor:', error);
                    showNotification('Error adding sponsor: ' + error.message, 'error');
                });
        });

        goalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newGoal = {
                title: document.getElementById('goal-title').value,
                deadline: document.getElementById('goal-deadline').value,
                priority: document.getElementById('goal-priority').value,
                description: document.getElementById('goal-description').value,
                progress: document.getElementById('goal-progress').value
            };
            
            saveGoal(newGoal)
                .then(() => {
                    goalForm.reset();
                    closeAllModals();
                    showNotification('Goal added successfully!', 'success');
                })
                .catch((error) => {
                    console.error('Error adding goal:', error);
                    showNotification('Error adding goal: ' + error.message, 'error');
                });
        });

        dealForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // KËTU ËSHTË RREGULLIMI KYÇ - MOS E KONVERTO NË NUMËR!
            const newDeal = {
                eventId: document.getElementById('deal-event').value, // STRING, jo parseInt!
                company: document.getElementById('deal-company').value,
                contact: document.getElementById('deal-contact').value,
                email: document.getElementById('deal-email').value,
                phone: document.getElementById('deal-phone').value,
                status: document.getElementById('deal-status').value,
                notes: document.getElementById('deal-notes').value
            };
            
            saveDeal(newDeal)
                .then(() => {
                    dealForm.reset();
                    closeAllModals();
                    showNotification('Deal added successfully!', 'success');
                    
                    // Update CRM if we're on that page
                    const currentPage = document.querySelector('.page.active').id;
                    if (currentPage === 'crm-page') {
                        const selectedEventId = crmEventSelect.value;
                        if (selectedEventId === newDeal.eventId) {
                            renderCRMTable(selectedEventId);
                        }
                    }
                })
                .catch((error) => {
                    console.error('Error adding deal:', error);
                    showNotification('Error adding deal: ' + error.message, 'error');
                });
        });

        // Rendering functions
        function renderEvents() {
            if (events.length === 0) {
                eventsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-plus"></i>
                        <h3>No Events Yet</h3>
                        <p>Click the "Add New Event" button to create your first event</p>
                    </div>
                `;
                return;
            }
            
            eventsContainer.innerHTML = events.map(event => {
                const statusClass = event.status === 'pending' ? 'pending' : 
                                   event.status === 'confirmed' ? 'confirmed' : 'completed';
                
                let formattedDate = 'No date';
                if (event.date) {
                    // Check if date is a Firestore timestamp or a string
                    if (event.date.seconds) {
                        formattedDate = new Date(event.date.seconds * 1000).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } else {
                        formattedDate = new Date(event.date).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                }
                
                // Count deals for this event - PËRDOR === PËR KRAHASIM STRING
                const eventDeals = deals.filter(d => d.eventId === event.id);
                const dealCount = eventDeals.length;
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">${event.title}</h3>
                            <span class="status ${statusClass}">${event.status}</span>
                        </div>
                        <div class="card-details">
                            <p><strong>Date:</strong> ${formattedDate}</p>
                            <p><strong>Location:</strong> ${event.location}</p>
                            <p>${event.description}</p>
                            <div style="margin-top: 10px; padding: 8px; background-color: #f8f9fa; border-radius: 4px;">
                                <p style="margin: 0; font-size: 0.85rem;">
                                    <strong>CRM:</strong> ${dealCount} deal${dealCount !== 1 ? 's' : ''}
                                </p>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="card-actions">
                                <button class="action-btn edit-btn" data-id="${event.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="action-btn crm-btn" data-id="${event.id}">
                                    <i class="fas fa-table"></i> CRM
                                </button>
                                <button class="action-btn delete-btn" data-id="${event.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                            <div class="card-date">
                                <i class="far fa-calendar-alt"></i> ${formattedDate}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const eventId = this.getAttribute('data-id');
                    editEvent(eventId);
                });
            });
            
            document.querySelectorAll('.crm-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const eventId = this.getAttribute('data-id');
                    // Switch to CRM page and select this event
                    document.querySelector('.nav-link[data-page="crm"]').click();
                    crmEventSelect.value = eventId;
                    crmEventSelect.dispatchEvent(new Event('change'));
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const eventId = this.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this event? This will also delete all associated deals.')) {
                        // First delete associated deals, then delete the event
                        deleteDealsByEvent(eventId)
                            .then(() => deleteEvent(eventId))
                            .then(() => {
                                showNotification('Event and associated deals deleted!', 'info');
                            })
                            .catch((error) => {
                                console.error('Error deleting event:', error);
                                showNotification('Error deleting event: ' + error.message, 'error');
                            });
                    }
                });
            });
        }

        function renderSponsors() {
            if (sponsors.length === 0) {
                sponsorsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-handshake"></i>
                        <h3>No Sponsors Yet</h3>
                        <p>Click the "Add New Sponsor" button to add your first sponsor</p>
                    </div>
                `;
                return;
            }
            
            sponsorsContainer.innerHTML = sponsors.map(sponsor => {
                const levelClass = `level-${sponsor.level}`;
                const levelText = sponsor.level.charAt(0).toUpperCase() + sponsor.level.slice(1);
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">${sponsor.name}</h3>
                            <span class="sponsor-level ${levelClass}">${levelText}</span>
                        </div>
                        <div class="card-details">
                            <p><strong>Email:</strong> ${sponsor.email}</p>
                            <p><strong>Phone:</strong> ${sponsor.phone || 'Not provided'}</p>
                            ${sponsor.notes ? `<p><strong>Notes:</strong> ${sponsor.notes}</p>` : ''}
                        </div>
                        <div class="card-footer">
                            <div class="card-actions">
                                <button class="action-btn email-btn" data-email="${sponsor.email}">
                                    <i class="fas fa-envelope"></i> Email
                                </button>
                                <button class="action-btn delete-btn" data-id="${sponsor.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                            <div class="card-date">
                                <i class="fas fa-star"></i> ${levelText} Sponsor
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners for buttons
            document.querySelectorAll('.email-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const email = this.getAttribute('data-email');
                    window.location.href = `mailto:${email}`;
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sponsorId = this.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this sponsor?')) {
                        deleteSponsor(sponsorId)
                            .then(() => {
                                showNotification('Sponsor deleted successfully!', 'info');
                            })
                            .catch((error) => {
                                console.error('Error deleting sponsor:', error);
                                showNotification('Error deleting sponsor: ' + error.message, 'error');
                            });
                    }
                });
            });
        }

        function renderGoals() {
            if (goals.length === 0) {
                goalsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bullseye"></i>
                        <h3>No Goals Yet</h3>
                        <p>Click the "Add New Goal" button to set your first goal</p>
                    </div>
                `;
                return;
            }
            
            goalsContainer.innerHTML = goals.map(goal => {
                let formattedDate = 'No deadline';
                if (goal.deadline) {
                    // Check if deadline is a Firestore timestamp or a string
                    if (goal.deadline.seconds) {
                        formattedDate = new Date(goal.deadline.seconds * 1000).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } else {
                        formattedDate = new Date(goal.deadline).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                }
                
                // Determine priority class
                let priorityClass = 'priority-medium';
                if (goal.priority === 'high') priorityClass = 'priority-high';
                if (goal.priority === 'low') priorityClass = 'priority-low';
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">${goal.title}</h3>
                            <div class="${priorityClass}">
                                ${goal.priority.charAt(0).toUpperCase() + goal.priority.slice(1)} Priority
                            </div>
                        </div>
                        <div class="card-details">
                            <p><strong>Deadline:</strong> ${formattedDate}</p>
                            <p><strong>Progress:</strong> ${goal.progress}%</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${goal.progress}%"></div>
                            </div>
                            <p>${goal.description}</p>
                        </div>
                        <div class="card-footer">
                            <div class="card-actions">
                                <button class="action-btn update-btn" data-id="${goal.id}">
                                    <i class="fas fa-sync-alt"></i> Update
                                </button>
                                <button class="action-btn delete-btn" data-id="${goal.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                            <div class="card-date">
                                Due: ${formattedDate}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners for buttons
            document.querySelectorAll('.update-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const goalId = this.getAttribute('data-id');
                    updateGoalProgress(goalId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const goalId = this.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this goal?')) {
                        deleteGoal(goalId)
                            .then(() => {
                                showNotification('Goal deleted successfully!', 'info');
                            })
                            .catch((error) => {
                                console.error('Error deleting goal:', error);
                                showNotification('Error deleting goal: ' + error.message, 'error');
                            });
                    }
                });
            });
        }

        // CRM Table rendering
        function renderCRMTable(eventId) {
            // PËRDOR === PËR KRAHASIM STRING
            const eventDeals = deals.filter(deal => deal.eventId === eventId);
            
            if (eventDeals.length === 0) {
                crmTableContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-table"></i>
                        <h3>No Deals Yet</h3>
                        <p>Click the "Add New Deal" button to add deals for this event</p>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <table class="crm-table">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Contact</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${eventDeals.map(deal => {
                            const statusClass = `status-${deal.status}`;
                            const statusText = deal.status.charAt(0).toUpperCase() + deal.status.slice(1);
                            let formattedDate = 'N/A';
                            
                            if (deal.lastUpdated && deal.lastUpdated.seconds) {
                                formattedDate = new Date(deal.lastUpdated.seconds * 1000).toLocaleDateString('en-US');
                            } else if (deal.createdAt && deal.createdAt.seconds) {
                                formattedDate = new Date(deal.createdAt.seconds * 1000).toLocaleDateString('en-US');
                            }
                            
                            return `
                                <tr data-id="${deal.id}">
                                    <td><input type="text" value="${deal.company}" class="editable company"></td>
                                    <td><input type="text" value="${deal.contact || ''}" class="editable contact"></td>
                                    <td><input type="email" value="${deal.email || ''}" class="editable email"></td>
                                    <td><input type="tel" value="${deal.phone || ''}" class="editable phone"></td>
                                    <td>
                                        <select class="editable status">
                                            <option value="new" ${deal.status === 'new' ? 'selected' : ''}>New</option>
                                            <option value="negotiation" ${deal.status === 'negotiation' ? 'selected' : ''}>Negotiation</option>
                                            <option value="won" ${deal.status === 'won' ? 'selected' : ''}>Won</option>
                                            <option value="lost" ${deal.status === 'lost' ? 'selected' : ''}>Lost</option>
                                            <option value="postponed" ${deal.status === 'postponed' ? 'selected' : ''}>Postponed</option>
                                        </select>
                                    </td>
                                    <td>${formattedDate}</td>
                                    <td>
                                        <button class="table-action-btn save" title="Save changes">
                                            <i class="fas fa-save"></i>
                                        </button>
                                        <button class="table-action-btn delete" title="Delete deal">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            crmTableContainer.innerHTML = tableHTML;
            
            // Add event listeners for inline editing
            crmTableContainer.querySelectorAll('.save').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const dealId = row.getAttribute('data-id');
                    saveDealChanges(dealId, row);
                });
            });
            
            crmTableContainer.querySelectorAll('.delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const dealId = row.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this deal?')) {
                        deleteDeal(dealId)
                            .then(() => {
                                showNotification('Deal deleted!', 'info');
                            })
                            .catch((error) => {
                                console.error('Error deleting deal:', error);
                                showNotification('Error deleting deal: ' + error.message, 'error');
                            });
                    }
                });
            });
        }

        // Edit event function
        function editEvent(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            
            // Populate the form with event data
            document.getElementById('event-title').value = event.title;
            
            // Convert Firestore timestamp to date string
            if (event.date) {
                let dateValue = '';
                if (event.date.seconds) {
                    const date = new Date(event.date.seconds * 1000);
                    dateValue = date.toISOString().split('T')[0];
                } else {
                    dateValue = event.date;
                }
                document.getElementById('event-date').value = dateValue;
            } else {
                document.getElementById('event-date').value = '';
            }
            
            document.getElementById('event-location').value = event.location;
            document.getElementById('event-description').value = event.description;
            document.getElementById('event-status').value = event.status;
            
            // Change form to update mode
            const form = document.getElementById('event-form');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update Event';
            
            // Remove old submit listener
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            
            // Add new submit listener for update
            newForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Update event data
                const updatedEvent = {
                    title: document.getElementById('event-title').value,
                    date: document.getElementById('event-date').value,
                    location: document.getElementById('event-location').value,
                    description: document.getElementById('event-description').value,
                    status: document.getElementById('event-status').value
                };
                
                updateEvent(eventId, updatedEvent)
                    .then(() => {
                        newForm.reset();
                        closeAllModals();
                        showNotification('Event updated successfully!', 'success');
                    })
                    .catch((error) => {
                        console.error('Error updating event:', error);
                        showNotification('Error updating event: ' + error.message, 'error');
                    });
            });
            
            openModal(eventModal);
        }

        // Update goal progress function
        function updateGoalProgress(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            const newProgress = prompt('Enter new progress percentage (0-100):', goal.progress);
            if (newProgress !== null && !isNaN(newProgress) && newProgress >= 0 && newProgress <= 100) {
                updateGoal(goalId, { progress: parseInt(newProgress) })
                    .then(() => {
                        showNotification('Goal progress updated!', 'success');
                    })
                    .catch((error) => {
                        console.error('Error updating goal:', error);
                        showNotification('Error updating goal: ' + error.message, 'error');
                    });
            }
        }

        // Save deal changes from inline editing
        function saveDealChanges(dealId, row) {
            const updatedDeal = {
                company: row.querySelector('.company').value,
                contact: row.querySelector('.contact').value,
                email: row.querySelector('.email').value,
                phone: row.querySelector('.phone').value,
                status: row.querySelector('.status').value
            };
            
            updateDeal(dealId, updatedDeal)
                .then(() => {
                    showNotification('Deal updated successfully!', 'success');
                })
                .catch((error) => {
                    console.error('Error updating deal:', error);
                    showNotification('Error updating deal: ' + error.message, 'error');
                });
        }

        // Update event selectors
        function updateEventSelectors() {
            // Update CRM event selector
            crmEventSelect.innerHTML = '<option value="">-- Select an Event --</option>' +
                events.map(event => {
                    let dateStr = 'No date';
                    if (event.date) {
                        if (event.date.seconds) {
                            dateStr = new Date(event.date.seconds * 1000).toLocaleDateString('en-US');
                        } else {
                            dateStr = new Date(event.date).toLocaleDateString('en-US');
                        }
                    }
                    return `<option value="${event.id}">${event.title} (${dateStr})</option>`;
                }).join('');
            
            // Update deal modal event selector
            if (dealEventSelect) {
                dealEventSelect.innerHTML = '<option value="">-- Select Event --</option>' +
                    events.map(event => `<option value="${event.id}">${event.title}</option>`).join('');
            }
        }

        // Populate deal event selector with only events
        function populateDealEventSelect() {
            if (dealEventSelect) {
                dealEventSelect.innerHTML = '<option value="">-- Select Event --</option>' +
                    events.map(event => `<option value="${event.id}">${event.title}</option>`).join('');
            }
        }

        // Update CRM summary
        function updateCRMSummary() {
            const totalDeals = deals.length;
            const wonDeals = deals.filter(deal => deal.status === 'won').length;
            
            document.getElementById('total-deals').textContent = totalDeals;
            document.getElementById('won-deals').textContent = wonDeals;
        }

        // Export deals to CSV
        function exportDealsToCSV() {
            const eventId = crmEventSelect.value;
            if (!eventId) {
                showNotification('Please select an event first!', 'warning');
                return;
            }
            
            const eventDeals = deals.filter(deal => deal.eventId === eventId);
            if (eventDeals.length === 0) {
                showNotification('No deals to export for this event!', 'warning');
                return;
            }
            
            const event = events.find(e => e.id === eventId);
            const eventName = event ? event.title.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'deals';
            
            // Create CSV content
            const headers = ['Company', 'Contact', 'Email', 'Phone', 'Status', 'Last Updated', 'Notes'];
            const csvRows = [headers.join(',')];
            
            eventDeals.forEach(deal => {
                let lastUpdated = 'N/A';
                if (deal.lastUpdated && deal.lastUpdated.seconds) {
                    lastUpdated = new Date(deal.lastUpdated.seconds * 1000).toISOString().split('T')[0];
                }
                
                const row = [
                    `"${deal.company}"`,
                    `"${deal.contact || ''}"`,
                    `"${deal.email || ''}"`,
                    `"${deal.phone || ''}"`,
                    deal.status,
                    lastUpdated,
                    `"${deal.notes || ''}"`
                ];
                csvRows.push(row.join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `emk_deals_${eventName}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showNotification('CSV exported successfully!', 'success');
        }

        // Notification function
        function showNotification(message, type) {
            // Remove any existing notification
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="notification-close">&times;</button>
            `;
            
            // Add styles for notification
            const style = document.createElement('style');
            style.textContent = `
                .notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 16px;
                    border-radius: 5px;
                    color: white;
                    font-weight: 600;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    min-width: 250px;
                    max-width: 90%;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                    z-index: 2000;
                    animation: slideIn 0.3s ease;
                }
                .notification.success { background-color: #27ae60; }
                .notification.info { background-color: #3498db; }
                .notification.warning { background-color: #f39c12; }
                .notification.error { background-color: #e74c3c; }
                .notification-close {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 1.3rem;
                    cursor: pointer;
                    margin-left: 10px;
                }
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                
                @media (max-width: 768px) {
                    .notification {
                        top: 10px;
                        right: 10px;
                        left: 10px;
                        max-width: calc(100% - 20px);
                        min-width: auto;
                    }
                }
            `;
            document.head.appendChild(style);
            
            // Add to page
            document.body.appendChild(notification);
            
            // Add close functionality
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.remove();
            });
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
